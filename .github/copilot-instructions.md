# Copilot Instructions - Google Photos Takeout Metadata Processor

## Architecture Overview

This is a **metadata processing tool** that applies Google Photos Takeout JSON metadata to image/video files using ExifTool. The core design follows a **strategy pattern** for flexible metadata writing rules.

### Key Components

- **`src/google_takeout_metadata/processor.py`** - Main entry point, orchestrates the entire workflow
- **`src/google_takeout_metadata/exif_writer.py`** - Strategy engine that applies metadata using ExifTool
- **`src/google_takeout_metadata/config_loader.py`** - Loads JSON configuration files for mappings
- **`src/google_takeout_metadata/sidecar.py`** - Parses Google Photos JSON sidecar files
- **`config/exif_mapping.json`** - Main configuration defining field mappings and strategies

## Strategy System (Critical Pattern)

The project uses **6 distinct strategies** for metadata writing, each handling different business logic:

```python
# Core strategies in exif_writer.py
strategies = {
    "write_if_missing": "Only write if tag doesn't exist",
    "write_if_blank_or_missing": "Write if absent or empty (robust)",
    "replace_all": "Always replace existing value", 
    "preserve_existing": "Never touch existing values",
    "clean_duplicates": "Add without duplicates (remove→add pattern)",
    "preserve_positive_rating": "Special logic for favorites/rating"
}
```

**Key Implementation Detail**: Each strategy generates specific ExifTool command arguments with conditional logic. The `preserve_positive_rating` strategy is complex business logic for handling favorites.

## Configuration System

Configuration lives in **`config/exif_mapping.json`** with this structure:

```json
{
  "exif_mapping": {
    "field_name": {
      "source_fields": ["json_field"],
      "target_tags_image": ["EXIF:Tag"],
      "target_tags_video": ["QuickTime:Tag"], 
      "default_strategy": "strategy_name",
      "normalize": "person_name",  // Special normalization
      "value_mapping": {"true": "5"}  // Value transformations
    }
  }
}
```

## Critical Workflows

### Testing Commands
```bash
# Run all 129 tests
python -m pytest tests/ -v

# Integration tests (require ExifTool)
python -m pytest tests/test_integration.py -v

# Strategy-specific tests  
python -m pytest tests/test_integration.py -k "strategy_pure" -v
```

### Main Processing
```bash
# Process Google Photos directory
python -m google_takeout_metadata "data/Google Photos/"

# With advanced options
python -m google_takeout_metadata "data/" --batch --local-time --overwrite
```

### Discovery Tools
```bash
# Auto-discover fields in your data (new workflow)
python tools/discover_fields.py "data/Google Photos/" --summary
# → Generates exif_mapping_autogenerated.json

# Clean and activate configuration
python tools/clean_config_file.py
# → Reads exif_mapping_autogenerated.json
# → Saves clean version to exif_mapping.json (ready to use)

# Validate configuration
python tools/validate_config.py
```

## Important Patterns

### ExifTool Integration
- All metadata writing goes through **ExifTool subprocess calls**
- UTF-8 encoding is critical: `-charset utf8 -codedcharacterset=utf8`
- Commands use conditional logic: `-if` conditions for strategy enforcement
- Video vs image files use different tag sets

### Person Name Normalization
Special business logic in `normalize_person_name()`:
- "john DOE" → "John Doe" 
- Handles small words: "van", "de", "du", etc. stay lowercase
- Used with `"normalize": "person_name"` in config

### Duplicate Handling
The `clean_duplicates` strategy uses a **remove-then-add pattern**:
```bash
exiftool -PersonInImage-="John Doe" -PersonInImage+="John Doe" file.jpg
```

## Testing Architecture  

### Test Categories
- **Unit tests**: `test_exif_writer.py`, `test_config_loader.py` - Mock ExifTool
- **Integration tests**: `test_integration.py` - Real ExifTool execution  
- **End-to-end**: `test_end_to_end.py` - Full workflow validation

### Test Assets
- `test_assets/` contains clean test images/videos
- Tests copy assets to avoid pollution
- Integration tests verify actual EXIF writing

## Development Guidelines

### Adding New Strategies
1. Define strategy in `config/exif_mapping.json`
2. Implement logic in `exif_writer.py` `_generate_strategy_args()`
3. Add integration test in `test_integration.py`
4. Update strategy documentation

### Configuration Changes
- Always validate with `tools/validate_config.py`
- Test with `tools/discover_fields.py` on sample data
- Update both image and video tag mappings when needed

### ExifTool Debugging
```bash
# Check ExifTool version (requires 13.34+)
exiftool -ver

# Test commands manually
exiftool -json -charset utf8 test_image.jpg
```

## Common Pitfalls

- **Strategy conditions**: "Files failed condition" is normal - means strategy condition correctly prevented writing
- **UTF-8 encoding**: Always use charset parameters with ExifTool
- **Video vs Image tags**: Different tag sets required (QuickTime vs EXIF/XMP)
- **Person normalization**: Must handle edge cases like "McDonald", "O'Brien"
- **Path handling**: Use `Path` objects, be careful with Windows paths