# üì∏ Google Photos Takeout Metadata Processor

**Outil professionnel pour appliquer automatiquement les m√©tadonn√©es JSON de Google Photos Takeout √† vos fichiers images/vid√©os avec un syst√®me de strat√©gies avanc√©.**

[![Tests](https://img.shields.io/badge/tests-119%20passing-green)](tests/)
[![Python](https://img.shields.io/badge/python-3.10%2B-blue)](https://python.org)
[![ExifTool](https://img.shields.io/badge/exiftool-13.34%2B-orange)](https://exiftool.org)

---

## üéØ Fonctionnalit√©s Principales

‚úÖ **Syst√®me de strat√©gies sophistiqu√©** - Contr√¥le pr√©cis de l'√©criture des m√©tadonn√©es  
‚úÖ **Configuration JSON flexible** - Mapping personnalisable des champs vers les tags EXIF/XMP  
‚úÖ **Gestion intelligente des doublons** - √âvite la duplication des personnes et albums  
‚úÖ **Support GPS et g√©olocalisation** - Pr√©servation des coordonn√©es g√©ographiques  
‚úÖ **Rating/Favoris avanc√©** - Logique sp√©ciale pour les photos favorites  
‚úÖ **Normalisation automatique** - Casse intelligente pour noms de personnes  
‚úÖ **119 tests automatis√©s** - Fiabilit√© et robustesse garanties  

## ‚ö° Installation et D√©marrage Rapide

### Pr√©requis
```bash
# 1. Installer ExifTool (requis)
# Windows: scoop install exiftool
# macOS: brew install exiftool  
# Linux: sudo apt install libimage-exiftool-perl

# 2. Installer les d√©pendances Python
pip install -r requirements.txt
```

### Usage de base
```bash
# Traiter un dossier Google Photos Takeout
python -m google_takeout_metadata "data/Google Photos/"

# Avec options avanc√©es
python -m google_takeout_metadata "data/Google Photos/" \
    --batch \
    --local-time \
    --overwrite
```

## ü™ü Scripts Windows (Glisser-D√©poser)

**Pour les utilisateurs Windows : traitement ultra-simple par glisser-d√©poser !**

```bash
# Glissez-d√©posez votre dossier "Google Photos" directement sur :
google_photos_processor.bat      # Script Batch classique
google_photos_processor.ps1      # Script PowerShell (recommand√©)
```

**Avantages :**
- üñ±Ô∏è **Glisser-d√©poser** ‚Üí Aucune ligne de commande n√©cessaire
- üéØ **Menu interactif** ‚Üí Choisissez vos options facilement  
- ‚úÖ **V√©rifications automatiques** ‚Üí Python, ExifTool, fichiers JSON
- üîß **Gestion d'erreurs** ‚Üí Diagnostic et aide int√©gr√©s

> üìñ **Voir [SCRIPTS_README.md](SCRIPTS_README.md)** pour le guide complet des scripts Windows

## üîß Workflow de Configuration Automatis√©e

### G√©n√©ration automatique d'une configuration sur mesure

```bash
# 1. üîç D√©couvrir automatiquement les champs dans vos donn√©es
python tools/discover_fields.py "data/Google Photos/"
# ‚Üí Analyse vos fichiers JSON Google Photos
# ‚Üí G√©n√®re exif_mapping_autogenerated.json avec tous les champs trouv√©s

# 2. üßπ Nettoyer et activer la configuration  
python tools/clean_config_file.py
# ‚Üí Lit exif_mapping_autogenerated.json
# ‚Üí Supprime les infos de debug
# ‚Üí Sauvegarde dans exif_mapping.json (pr√™t √† l'emploi)

# 3. ‚úÖ Ex√©cuter le traitement avec votre config personnalis√©e
python -m google_takeout_metadata "data/Google Photos/"
# ‚Üí Utilise automatiquement exif_mapping.json
```

**Avantages :**
- üéØ **Config sur mesure** ‚Üí Bas√©e sur vos vraies donn√©es Google Photos
- üöÄ **Workflow fluide** ‚Üí 3 commandes pour une config optimale  
- ‚úÖ **Pr√™t √† l'emploi** ‚Üí G√©n√®re directement le bon nom de fichier
- üîß **Personnalisable** ‚Üí √âditez exif_mapping.json selon vos besoins


## üèóÔ∏è Architecture et Strat√©gies

### Strat√©gies de M√©tadonn√©es Disponibles

| Strat√©gie | Description | Usage |
|-----------|-------------|-------|
| `write_if_missing` | √âcrit seulement si le tag n'existe pas | Titres, champs de base |
| `write_if_blank_or_missing` | √âcrit si absent ou vide (robuste) | Descriptions |
| `replace_all` | Remplace toujours la valeur | Dates, coordonn√©es GPS |
| `preserve_existing` | Ne touche jamais aux valeurs existantes | Protection de donn√©es |
| `clean_duplicates` | Ajoute sans doublons (remove‚Üíadd) | Personnes, mots-cl√©s |
| `preserve_positive_rating` | Logique sp√©ciale favoris/rating | Photos favorites |

### Configuration par D√©faut

```json
{
  "exif_mapping": {
    "description": {
      "target_tags_image": ["MWG:Description"],
      "default_strategy": "write_if_blank_or_missing"
    },
    "people_name": {
      "target_tags_image": ["XMP-iptcExt:PersonInImage"],
      "default_strategy": "clean_duplicates",
      "normalize": "person_name"
    },
    "favorited": {
      "target_tags_image": ["XMP:Rating"],
      "default_strategy": "preserve_positive_rating",
      "value_mapping": {"true": "5", "false": null}
    }
  }
}
```

## üìã Champs Support√©s

### M√©tadonn√©es Texte
- **Description** ‚Üí `MWG:Description`
- **Titre** ‚Üí `IPTC:ObjectName`, `XMP-dc:Title`
- **Personnes** ‚Üí `XMP-iptcExt:PersonInImage`, mots-cl√©s
- **Albums** ‚Üí Mots-cl√©s avec pr√©fixe "Album: "

### M√©tadonn√©es Techniques
- **Dates de cr√©ation** ‚Üí `EXIF:DateTimeOriginal`, `EXIF:CreateDate`
- **GPS (latitude/longitude/altitude)** ‚Üí Tags GPS standard
- **Rating/Favoris** ‚Üí `XMP:Rating` (5 si favori)

### Normalisation Automatique
- **Noms de personnes** : "john DOE" ‚Üí "John Doe"
- **Mots-cl√©s** : Capitalisation intelligente
- **Petits mots** : "de", "du", "van", etc. en minuscules

## üîß Outils de D√©veloppement

### G√©n√©ration de Configuration
```bash
# D√©couverte automatique ‚Üí Configuration pr√™te √† l'emploi
python tools/discover_fields.py "data/Google Photos/"  # G√©n√®re _autogenerated.json
python tools/clean_config_file.py                      # Nettoie ‚Üí exif_mapping.json

# D√©couverte avec options avanc√©es
python tools/discover_fields.py "data/Google Photos/" --summary --output custom_config.json

# Validation et nettoyage de configuration
python tools/validate_config.py                        # Valide config actuelle
python tools/validate_config.py --clean               # Nettoie et optimise
python tools/validate_config.py --min-frequency 5     # Supprime champs rares

# Nettoyage des infos de debug
python tools/clean_config_file.py config/custom.json  # Nettoie un fichier sp√©cifique
```

### Tests et Validation
```bash
# Ex√©cuter tous les tests
python -m pytest tests/ -v

# Tests d'int√©gration uniquement
python -m pytest tests/test_integration.py -v

# Tests par strat√©gie
python -m pytest tests/test_integration.py -k "strategy_pure" -v
```

## ÔøΩ Structure du Projet

```
üìÅ exif_metadata_google_photo_takeout/
‚îú‚îÄ‚îÄ üìÅ config/
‚îÇ   ‚îú‚îÄ‚îÄ exif_mapping.json                    ‚Üê Configuration active (12 champs optimis√©s)
‚îÇ   ‚îú‚îÄ‚îÄ exif_mapping_autogenerated.json     ‚Üê Config auto-g√©n√©r√©e (d√©couverte)
‚îÇ   ‚îî‚îÄ‚îÄ exif_mapping_old.json               ‚Üê Backup ancienne config
‚îú‚îÄ‚îÄ üìÅ src/google_takeout_metadata/
‚îÇ   ‚îú‚îÄ‚îÄ processor.py                         ‚Üê Point d'entr√©e principal
‚îÇ   ‚îú‚îÄ‚îÄ exif_writer.py                      ‚Üê Syst√®me de strat√©gies
‚îÇ   ‚îú‚îÄ‚îÄ config_loader.py                    ‚Üê Chargement configuration
‚îÇ   ‚îú‚îÄ‚îÄ sidecar.py                          ‚Üê Parsing JSON Google
‚îÇ   ‚îî‚îÄ‚îÄ file_organizer.py                   ‚Üê Organisation archived/trashed
‚îú‚îÄ‚îÄ üìÅ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_integration.py       ‚Üê Tests complets (10 tests)
‚îÇ   ‚îú‚îÄ‚îÄ test_exif_writer.py       ‚Üê Tests unitaires
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py                 ‚Üê 129 tests au total
‚îú‚îÄ‚îÄ üìÅ tools/
‚îÇ   ‚îú‚îÄ‚îÄ discover_fields.py        ‚Üê D√©couverte automatique
‚îÇ   ‚îú‚îÄ‚îÄ validate_config.py        ‚Üê Validation config
‚îÇ   ‚îî‚îÄ‚îÄ demo_discovery.py         ‚Üê D√©monstrations
‚îî‚îÄ‚îÄ üìÅ docs/
    ‚îú‚îÄ‚îÄ strategies.md              ‚Üê Guide des strat√©gies
    ‚îî‚îÄ‚îÄ discovery.md               ‚Üê Processus de d√©couverte
```

## üöÄ Cas d'Usage Avanc√©s

### Traitement par Lots
```bash
# Mode batch avec toutes les options
python -m google_takeout_metadata \
    "data/Google Photos/" \
    --batch \
    --local-time \
    --overwrite \
    --immediate-delete \
    --organize-files \
    --geocode

# Options principales expliqu√©es
--batch                # Traitement par lots (plus rapide)
--local-time          # Conversion heure locale (vs UTC)
--overwrite           # √âcraser m√©tadonn√©es existantes
--immediate-delete    # Supprimer JSON apr√®s succ√®s (vs pr√©fixe OK_)
--organize-files      # Organiser fichiers archiv√©s/supprim√©s
--geocode             # G√©ocodage inverse (API Google Maps)
--verbose             # Logs d√©taill√©s (niveau DEBUG)
```

### Configuration Personnalis√©e
```bash
# Utiliser une configuration sp√©cifique
EXIF_CONFIG_PATH="config/custom_mapping.json" \
    python -m google_takeout_metadata "data/"
```

### G√©ocodage avec API Google Maps
```bash
# 1. Configurer la cl√© API (obligatoire pour --geocode)
export GOOGLE_MAPS_API_KEY="votre-cle-api-google-maps"

# 2. Activer le g√©ocodage 
python -m google_takeout_metadata \
    "data/Google Photos/" \
    --geocode

# Note: Si GOOGLE_MAPS_API_KEY est absente, un warning est affich√©
# mais le traitement continue sans g√©ocodage
```

**Obtenir une cl√© API Google Maps :**
1. Aller sur [Google Cloud Console](https://console.cloud.google.com)
2. Activer l'API "Geocoding API"
3. Cr√©er une cl√© API
4. D√©finir `GOOGLE_MAPS_API_KEY=votre-cl√©` dans votre environnement

### Debugging et Logs
```bash
# Mode verbose avec logs d√©taill√©s
python -m google_takeout_metadata \
    "data/Google Photos/" \
    --verbose

# Mode tr√®s d√©taill√© pour diagnostic
python -m google_takeout_metadata \
    "data/Google Photos/" \
    --verbose \
    --batch

# Test √† sec (aper√ßu sans modification)  
python -m google_takeout_metadata \
    "data/Google Photos/" \
    --dry-run \
    --verbose
```

**Types de logs disponibles :**
- `INFO` (d√©faut) : Progression et r√©sultats
- `DEBUG` (--verbose) : D√©tails techniques et commandes ExifTool
- `WARNING` : Alertes et probl√®mes non-bloquants
- `ERROR` : Erreurs de traitement

## üîç Logique M√©tier Sp√©ciale

### Photos Favorites (preserve_positive_rating)
- `favorited=true` + `Rating>0` ‚Üí **Pr√©server** le rating existant
- `favorited=true` + `Rating=0/absent` ‚Üí **√âcrire** Rating=5
- `favorited=false` ‚Üí **Ne jamais toucher** au rating

### Gestion des Personnes (clean_duplicates)
- Normalisation automatique : "jane doe" ‚Üí "Jane Doe"  
- D√©duplication robuste : √©vite les doublons lors d'ajouts
- Pattern ExifTool : `-PersonInImage-=Nom` puis `-PersonInImage+=Nom`

### Descriptions (write_if_blank_or_missing)
- Condition robuste : `not defined $tag or not length($tag) or not length($tag[0])`
- Support multi-langues et lang-alt
- Pr√©servation des descriptions existantes

## üß™ Tests et Qualit√©

### Couverture de Tests
- **119 tests** au total
- **10 tests d'int√©gration** complets
- **6 tests purs par strat√©gie**
- **Tests GPS, favoris, personnes**
- **Validation ExifTool directe**

### Tests Sp√©cifiques par Strat√©gie
```bash
# Test preserve_positive_rating
python -m pytest tests/test_integration.py::test_preserve_positive_rating_strategy_pure -v

# Test clean_duplicates  
python -m pytest tests/test_integration.py::test_clean_duplicates_strategy_pure -v

# Test write_if_blank_or_missing
python -m pytest tests/test_integration.py::test_write_if_blank_or_missing_strategy_pure -v
```

## üêõ Debugging et D√©pannage

### Logs et Diagnostics
```bash
# Activer les logs debug
python -m google_takeout_metadata \
    "data/" --verbose --log-level DEBUG

# Tester ExifTool directement
exiftool -ver  # V√©rifier version ExifTool
```

### Probl√®mes Courants

**ExifTool introuvable**
```bash
# V√©rifier l'installation
exiftool -ver
# Si erreur: installer ExifTool ou l'ajouter au PATH
```

**Files failed condition**
```
# Normal ! Signifie que la condition de strat√©gie a √©chou√©
# Ex: preserve_existing sur un champ d√©j√† rempli
```

**Encodage des caract√®res**
```bash
# L'outil g√®re UTF-8 automatiquement
# Options ExifTool : -charset utf8 -codedcharacterset=utf8
```

## ü§ù Contribution

### D√©veloppement Local
```bash
# Cloner et installer
git clone <repo>
cd exif_metadata_google_photo_takeout
pip install -r requirements.txt

# Ex√©cuter les tests
python -m pytest tests/ -v

# V√©rifier la qualit√© du code  
python -m pytest tests/ --tb=short
```

### Ajouter une Nouvelle Strat√©gie

1. **D√©finir dans config** : `config/exif_mapping.json`
2. **Impl√©menter la logique** : `src/google_takeout_metadata/exif_writer.py`
3. **Ajouter des tests** : `tests/test_integration.py`
4. **Documenter** : `docs/strategies.md`

## üìÑ Licence

[Voir LICENSE](LICENSE)

---

**üéâ Pr√™t √† traiter vos photos Google ?**

```bash
python -m google_takeout_metadata "data/Google Photos/"
```

**Questions ?** Consultez [`docs/`](docs/) ou ouvrez une issue !
